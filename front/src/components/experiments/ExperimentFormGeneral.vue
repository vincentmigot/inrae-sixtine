<template>
  <div>
    <ValidationObserver ref="validatorRef">
      <b-form>
        <!-- URI -->
        <b-form-group>
          <ValidationProvider vid="autogeneratedExpe">
            <b-form-checkbox
              v-if="!editMode"
              id="autogeneratedExpe"
              v-model="uriGenerated"
              name="autogeneratedExpe"
            >
              <opensilex-FormInputLabelHelper
                label="component.experiment.uri"
                helpMessage="component.common.uri.help-message"
                labelFor="urixp"
              ></opensilex-FormInputLabelHelper>
            </b-form-checkbox>
          </ValidationProvider>
          <ValidationProvider
            name="urixp"
            rules="required_if:autogeneratedExpe,false|url"
            v-slot="{ errors }"
          >
            <b-form-input
              id="urixp"
              v-model="form.uri"
              :disabled="uriGenerated"
              type="text"
              required
              :placeholder="$t('component.common.autogenerated-uri')"
            ></b-form-input>
            <div class="error-message alert alert-danger">{{ errors[0] }}</div>
          </ValidationProvider>
        </b-form-group>
        <!-- Label -->

        <div class="row">
          <!-- StartDate -->
          <div class="col-lg-6">
            <b-form-group
              required
              :label="$t('component.experiment.label') + ':'"
              label-for="label"
            >
              <ValidationProvider
                :name="$t('component.experiment.label')"
                rules="required"
                v-slot="{ errors }"
              >
                <b-form-input
                  id="label"
                  v-model="form.label"
                  type="text"
                  required
                  :placeholder="$t('component.experiment.label-placeholder')"
                ></b-form-input>
                <div class="error-message alert alert-danger">{{ errors[0] }}</div>
              </ValidationProvider>
            </b-form-group>
          </div>

          <!-- Type -->
          <div class="col-lg-6">
            <b-form-group :label="$t('component.common.type') + ':'" label-for="type" required>
              <ValidationProvider
                :name="$t('component.common.type')"
                rules="required"
                v-slot="{ errors }"
              >
                <treeselect
                  id="type"
                  :options="experimentTypesOptions"
                  :load-options="initExperimentTypes"
                  :placeholder="$t('component.experiment.form-type-placeholder')"
                  v-model="form.type"
                />
                <div class="error-message alert alert-danger">{{ errors[0] }}</div>
              </ValidationProvider>
            </b-form-group>
          </div>
        </div>
        <div class="row">
          <!-- StartDate -->
          <div class="col-lg-6">
            <b-form-group
              required
              :label="$t('component.experiment.startDate') + ':'"
              label-for="startDate"
            >
              <ValidationProvider
                :name="$t('component.experiment.startDate')"
                rules="required"
                v-slot="{ errors }"
              >
                <b-form-input
                  id="startDate"
                  v-model="form.startDate"
                  type="date"
                  value="2020-03-05"
                  required
                ></b-form-input>
                <div class="error-message alert alert-danger">{{ errors[0] }}</div>
              </ValidationProvider>
            </b-form-group>
          </div>
          <!-- EndDate -->
          <div class="col-lg-6">
            <b-form-group :label="$t('component.experiment.endDate') + ':'" label-for="endDate">
              <ValidationProvider :name="$t('component.experiment.endDate')" v-slot="{ errors }">
                <b-form-input id="endDate" v-model="form.endDate" type="date" value="2020-03-05"></b-form-input>
                <div class="error-message alert alert-danger">{{ errors[0] }}</div>
              </ValidationProvider>
            </b-form-group>
          </div>
        </div>

        <div class="row">
          <!-- Objective -->
          <b-form-group
            class="col-lg-6"
            :label="$t('component.experiment.objective') + ':'"
            label-for="objective"
          >
            <ValidationProvider :name="$t('component.experiment.objective')" v-slot="{ errors }">
              <b-form-textarea
                id="objective"
                v-model="form.objective"
                type="textarea"
                rows="6"
                :placeholder="$t('component.experiment.objective-placeholder')"
              ></b-form-textarea>
              <div class="error-message alert alert-danger">{{ errors[0] }}</div>
            </ValidationProvider>
          </b-form-group>

          <!-- Comment -->
          <b-form-group
            class="col-lg-6"
            :label="$t('component.experiment.comment') + ':'"
            label-for="comment"
          >
            <ValidationProvider :name="$t('component.experiment.comment')" v-slot="{ errors }">
              <b-form-textarea
                id="comment"
                v-model="form.comment"
                type="textarea"
                rows="6"
                :placeholder="$t('component.experiment.comment-placeholder')"
              ></b-form-textarea>
              <div class="error-message alert alert-danger">{{ errors[0] }}</div>
            </ValidationProvider>
          </b-form-group>
        </div>
      </b-form>
    </ValidationObserver>
  </div>
</template>

<script lang="ts">
import { Component, Prop } from "vue-property-decorator";
import Vue from "vue";
import VueRouter from "vue-router";

import {
  SpeciesService,
  SpeciesDTO,
  ResourceTreeDTO
} from "opensilex-core/index";
import HttpResponse, { OpenSilexResponse } from "opensilex-core/HttpResponse";
import Oeso from "../../../../../opensilex-front/front/src/ontologies/Oeso";
import { ExperimentCreationDTO } from "../../lib";

const EXPERIMENT_TYPE_URI = Oeso.EXPERIMENT_TYPE_URI;

@Component
export default class ExperimentFormGeneral extends Vue {
  $opensilex: any;
  $store: any;
  $router: VueRouter;
  $i18n: any;

  title = "";
  editMode = false;
  uriGenerated = true;
  ontologyService: any;

  experimentTypesOptions = null;

  @Prop()
  form: ExperimentCreationDTO;

  created() {
    this.ontologyService = this.$opensilex.getService(
      "opensilex-security.OntologyService"
    );
  }

  mounted() {
    this.$store.watch(
      () => this.$store.getters.language,
      lang => {
        this.loadExperimentTypes();
      }
    );
  }

  initExperimentTypes({ action, parentNode, callback }) {
    this.loadExperimentTypes(callback);
  }

  loadExperimentTypes(callback?) {
    this.ontologyService
      .getSubClassesOf(EXPERIMENT_TYPE_URI, true)
      .then((http: HttpResponse<OpenSilexResponse<Array<ResourceTreeDTO>>>) => {
        this.experimentTypesOptions = this.$opensilex.buildTreeListOptions(
          http.response.result
        );
        if (callback) {
          callback();
        }
      })
      .catch(this.$opensilex.errorHandler);
  }

  get user() {
    return this.$store.state.user;
  }
}
</script>

<style scoped lang="scss">
</style>
